#version: '3.3'

services:
  # PostgreSQL Service
  postgres:
    image: postgres:15.6 # Use the official PostgreSQL version 15.6 image
    container_name: postgres # Set a custom name for the PostgreSQL container
    environment:
      POSTGRES_USER: username # Username for PostgreSQL
      POSTGRES_PASSWORD: password # Password for PostgreSQL
      POSTGRES_DB: autolabeling # Default database to be created
    volumes:
      - postgres_data:/var/lib/postgresql/data # Persist PostgreSQL data using a Docker volume
    # No host port mapping needed; other services talk to postgres over the internal Docker network.
    # This also avoids conflicts if some other PostgreSQL is already using 5432 on the host.

  ## Redis Service
  redis:
    image: redis/redis-stack:latest 
    container_name: redis-stack # Set a custom name for the Redis container
    environment:
      REDIS_ARGS: "--requirepass password" # Set a password for Redis to enhance security
    ports:
      - '6379:6379' # Expose port 6379 for Redis
    volumes:
      - redis_data:/data # Persist Redis data using a Docker volume

  # Autolabeling API Service
  api:
    build:
      context: ./autolabel-anything-api
      dockerfile: Dockerfile
    container_name: autolabeling-api
    depends_on:
      - postgres
      - redis
    env_file:
      - ./autolabel-anything-api/.env
    ports:
      - '8000:8051'
    volumes:
      - ./autolabeling_data:/data
      # Make host videos in ./autolabel_data/user_videos visible where the API expects them
      # (inside the container at /data/autolabeling_data/user_videos)
      - ./autolabel_data/user_videos:/data/autolabeling_data/user_videos
    # Request all available GPUs for this service (Docker with NVIDIA runtime)
    gpus: all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]

  # Autolabeling Backend Service
  sam2-services:
    build:
      context: ./autolabel-anything-sam2-services
      dockerfile: Dockerfile
    container_name: sam2-services
    depends_on:
      - api
      - postgres
      - redis
    env_file:
      - ./autolabel-anything-sam2-services/.env
    environment:
      HYDRA_FULL_ERROR: "1"
      SAM2_FORCE_CPU: "1"
      # Ensure local SAM2 source tree is importable so Hydra can resolve
      # targets like 'sam2.modeling.backbones.hieradet.Hiera' even if
      # the installed package is out of sync.
      PYTHONPATH: /app/segment-anything-2:${PYTHONPATH}
    volumes:
      - ./autolabeling_data:/data
      # Same mapping for the SAM2 service so it sees the same user_videos directory
      - ./autolabel_data/user_videos:/data/autolabeling_data/user_videos
      # Mount selected source directories for faster dev without rebuilding the image
      - ./autolabel-anything-sam2-services/services:/app/services
      - ./autolabel-anything-sam2-services/ai_module:/app/ai_module
      - ./autolabel-anything-sam2-services/worker.py:/app/worker.py
    # Request all available GPUs for this service (Docker with NVIDIA runtime)
    gpus: all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]

  # Autolabeling Frontend Service
  frontend:
    build:
      context: ./autolabel-anything-ui
      dockerfile: Dockerfile
    container_name: autolabeling-frontend
    depends_on:
      - api
    env_file:
      - ./autolabel-anything-ui/.env
    ports:
      - '3000:3000'

volumes:
  postgres_data: # Docker volume to persist PostgreSQL data
  redis_data: # Docker volume to persist Redis data
